<!--
Copyright 2019 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<!DOCTYPE html>
<html>

<head>
  <script src="js/header-loader.js" onload="loadHeader('User Page')"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/12.0.0/classic/ckeditor.js"></script>
  <script src="js/user-page-loader.js"></script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrMAbbdB_aWldH5uEIQ6Nu2SdPjPWFNo8&libraries=places&callback=initMap"
    async defer></script>
  <link rel="stylesheet" href="/css/user-page.css" />
  <link rel="stylesheet" href="/css/message.css" />
  <script>
    function onClickEditProfileButton() {
      document.getElementById("edit-profile-button").classList.add("hidden");
      document
        .getElementById("profile-info-container")
        .classList.add("hidden");
      document
        .getElementById("profile-form-container")
        .classList.remove("hidden");
    }

    function onCancelEditProfileButton() {
      document
        .getElementById("profile-form-container")
        .classList.add("hidden");
      document
        .getElementById("edit-profile-button")
        .classList.remove("hidden");
      document
        .getElementById("profile-info-container")
        .classList.remove("hidden");
    }

    function onClickSubmitProfileButton() {
      const profile = {
        aboutme: document.getElementById("aboutme-input").value,
        username: document.getElementById("username-input").value,
        location: document.getElementById("location-input").value,
        organization: document.getElementById("organization-input").value,
        website: document.getElementById("website-input").value,
        langCodeForTranslation: document.getElementById(
          "language-for-translation-input"
        ).value
      };
      $.ajax({
        contentType: "application/json",
        data: JSON.stringify(profile),
        processData: false,
        type: "POST",
        url: "/user-profile"
      }).done(() => {
        onCancelEditProfileButton();
        fetchUserProfile();
        reBuildUsername();
        rebuildTranslationText();
      });
    }

    function rebuildTranslationText() {
      document
        .querySelectorAll("[id^=translateCollapseDiv-]")
        .forEach(div => {
          const id = div.id;
          const messageId = id.replace("translateCollapseDiv-", "");
          $.getScript("/js/message-loader.js", () => {
            getTranslatedText(
              document.getElementById(`text-${messageId}`).innerHTML,
              document.getElementById("language-for-translation-input").value
            ).then(translatedText => {
              document.getElementById(
                `translateCollapseDiv-${messageId}`
              ).innerHTML = translatedText;
            });
          });
        });
    }

    function reBuildUsername() {
      const usernameContainers = document.querySelectorAll(`[id='username']`);
      usernameContainers.forEach(div => {
        $.getScript("/js/message-loader.js", () => {
          div.innerHTML = getUsername(
            new URLSearchParams(window.location.search).get("user")
          );
        });
      });
    }

    function initMap() {
      var input = document.getElementById("searchMapInput");
      var autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.addListener("place_changed", function () {
        var place = autocomplete.getPlace();
      });
    }
  </script>
</head>

<body onload="buildUI();">
  <div class="content-container mt-7 pt-4">
    <div class="left-container pr-4 position-fixed">
      <form id="profile-image-form" method="POST" class="mb-5" enctype="multipart/form-data">
        <div class="profile-image-container">
          <img id="user-profile-image" alt="User Profile Image" class="rounded border" />
          <label class="edit-profile-image p-1 m-0 border-0 btn btn-default btn-file hidden" id="edit-profile-image">
            <i class="fas fa-pencil-alt fa-2x"></i>
            <input type="file" name="image" accept="image/*" id="profile-image-upload-input" style="display: none;" />
          </label>
        </div>
      </form>

      <div class="profile-container mt-5" id="profile-container">
        <div id="profile-info-container">
          <div class="border-bottom pb-3 pl-1">
            <h4 class="card-title" id="username"></h4>
            <h6 class="font-weight-lighter text-muted" id="aboutme"></h6>
          </div>

          <div class="font-weight-lighter mt-3" id="profile-detail-container"></div>
        </div>

        <button class="btn btn-outline-info btn-sm hidden mt-3" type="button" id="edit-profile-button"
          onclick="onClickEditProfileButton();">
          Edit Profile
        </button>

        <div id="profile-form-container" class="profileForm hidden">
          <div class="button-container d-flex justify-content-center">
            <button type="button" id="profile-submit-button" class="btn btn-sm btn-info mr-4"
              onclick="onClickSubmitProfileButton();">
              Submit
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="onCancelEditProfileButton();">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="right-container pl-4 mt-2">
      <form id="message-form" method="POST" class="hidden mb-5" enctype="multipart/form-data">
        <div>
          <textarea name="message" id="message-input" rows="10"></textarea>
          <div id="buttons-container"
            class="buttons-container d-flex justify-content-between p-1 border-top-0 border card-footer">
            <label id="upload-photo-button"
              class="btn btn-default btn-file btn-light btn-sm font-weight-light border-right mb-0 rounded-0">
              <i class="fas fa-camera-retro mr-1"></i>
              Photo
              <input type="file" name="image" accept="image/*" id="message-image-upload-input" style="display: none;" />
            </label>
            <input type="text" name="mapLocation" id="searchMapInput" class="mapControls"
              placeholder="Add location to map!" />
            <button type="submit" id="submit-button" class="btn btn-info btn-sm rounded-0 font-weight-bolder">
              <i class="fas fa-share-square mr-1"></i>
              Share
            </button>
          </div>
        </div>
      </form>

      <ul class="nav nav-tabs content-tab" id="tab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="gallery-tab" data-toggle="tab" href="#gallery" role="tab"
            aria-controls="gallery" aria-selected="true">Gallery</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="favourite-tab" data-toggle="tab" href="#favourite" role="tab"
            aria-controls="favourite" aria-selected="false">Favourite</a>
        </li>
      </ul>
      <div class="tab-content" id="tab-content">
        <div class="tab-pane fade show active user-gallery-container-tab-pane" id="gallery" role="tabpanel"
          aria-labelledby="gallery-tab">
          <div id="user-gallery-container" class="card-columns user-gallery-container">
            Loading...
          </div>
        </div>
        <div class="tab-pane fade favourite-messages-container-tab-pane" id="favourite" role="tabpanel"
          aria-labelledby="favourite-tab">
          <div id="favourite-messages-container" class="card-columns favourite-messages-container">
            Loading...
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>